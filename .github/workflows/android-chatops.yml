name: ðŸ¤– Android ChatOps

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      command:
        description: 'Command'
        required: true
        type: choice
        options: [/run-checks, /deploy-qa, /deploy-release]

permissions:
  contents: write
  pull-requests: write
  statuses: write
  deployments: write

jobs:
  authorize:
    if: >-
      github.event_name == 'workflow_dispatch' || 
      (github.event.issue.pull_request && startsWith(github.event.comment.body, '/'))
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.resolve.outputs.sha }}
      branch: ${{ steps.resolve.outputs.branch }}
    steps:
      - id: resolve
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
            echo "branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            PR_DATA=$(gh pr view ${{ github.event.issue.number }} --repo ${{ github.repository }} --json headRefOid,headRefName -q '.')
            echo "sha=$(echo $PR_DATA | jq -r .headRefOid)" >> $GITHUB_OUTPUT
            echo "branch=$(echo $PR_DATA | jq -r .headRefName)" >> $GITHUB_OUTPUT
          else
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

  reply-to-comment:
    needs: authorize
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment'
    steps:
      - name: Add reaction and reply
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: 'rocket'
          body: |
            > [!NOTE]
            > ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð° Ð´Ð»Ñ ÐºÐ¾Ð¼Ñ–Ñ‚Ñƒ `${{ needs.authorize.outputs.sha }}`.
            > Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¸ Ð·'ÑÐ²Ð»ÑÑ‚ÑŒÑÑ Ð² ÑÑ‚Ð°Ñ‚ÑƒÑÐ°Ñ… Ð½Ð¸Ð¶Ñ‡Ðµ. [ÐŸÐµÑ€ÐµÐ³Ð»ÑÐ½ÑƒÑ‚Ð¸ Ð»Ð¾Ð³](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

  slash-run-checks:
    needs: authorize
    if: >-
      contains(github.event.comment.body, '/run-checks') || 
      github.event.inputs.command == '/run-checks'
    uses: ./.github/workflows/code-quality-checks.yml
    with:
      sha: ${{ needs.authorize.outputs.sha }}
      branch_name: ${{ needs.authorize.outputs.branch }}

  slash-deploy-qa:
    needs: authorize
    if: >-
      contains(github.event.comment.body, '/deploy-qa') || 
      github.event.inputs.command == '/deploy-qa'
    uses: ./.github/workflows/deploy.yml
    with:
      target: 'debug'
      sha: ${{ needs.authorize.outputs.sha }}
      branch_name: ${{ needs.authorize.outputs.branch }}