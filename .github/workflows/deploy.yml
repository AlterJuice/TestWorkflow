name: üöÄ Android Deploy

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target'
        required: true
        default: 'debug'
        type: choice
        options: [debug, internal]
  workflow_call:
    inputs:
      target:
        required: true
        type: string

permissions:
  contents: read        # –î–ª—è —á–µ–∫–∞—É—Ç—É –∫–æ–¥—É
  deployments: write    # –ö–†–ò–¢–ò–ß–ù–û: –¥–æ–∑–≤–æ–ª—è—î —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ GitHub Deployments (—Å–µ–∫—Ü—ñ—è Environments —É –ü–†)
  pull-requests: write  # –Ø–∫—â–æ Fastlane –∞–±–æ —Å–∫—Ä–∏–ø—Ç–∏ –º–∞—é—Ç—å –ø–∏—Å–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏ –≤ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ
  statuses: write       # –©–æ–± –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –¥–∂–æ–±–∏ (—è–∫—â–æ –¥–µ–ø–ª–æ–π —Ç–µ–∂ —î —Å—Ç–∞—Ç—É—Å-—á–µ–∫–æ–º)

jobs:
  build-and-deploy:
    name: üöÄ Android Deploy [${{ inputs.target }}]
    runs-on: ubuntu-latest
    # Environment will show up in the PR under 'Deployments'
    environment: ${{ inputs.target == 'internal' && 'Google-Play-Internal' || 'Firebase-Debug' }}
    
    steps:
      - name: GitHub Deployments
        uses: bobheadxi/deployments@v1.5.0
        id: deployment
        with:
          step: start
          token: ${{ github.token }}
          env: ${{ inputs.target }}
          ref: ${{ inputs.sha || github.sha }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha || github.ref }}

      - name: Mock Deployment
        run: |
          echo "Deploying branch ${{ inputs.branch_name }} to ${{ inputs.target }}"
          echo "Commit SHA: ${{ inputs.sha }}"
          sleep 10
          echo "Deployment successful! üöÄ"

      - name: Update Deployment Status
        uses: bobheadxi/deployments@v1.5.0
        if: always()
        with:
          step: finish
          token: ${{ github.token }}
          status: ${{ job.status }}
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
          env: ${{ steps.deployment.outputs.env }}