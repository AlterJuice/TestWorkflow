name: "üîé Code Quality Checks"

permissions:
  statuses: write  # –¶–ï –ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø –û–ù–û–í–õ–ï–ù–ù–Ø –ì–ê–õ–û–ß–û–ö
  security-events: write  # –û–ë–û–í'–Ø–ó–ö–û–í–û –î–õ–Ø upload-sarif


on:
  workflow_dispatch:
  workflow_call:
    inputs:
      sha:
        type: string
        required: false
      branch_name:
        type: string
        required: false

jobs:
  code-quality-checks:
    name: "üõ°Ô∏è Quality Gate" # Exact name for Branch Protection
    runs-on: ubuntu-latest
    env:
      CI_COMMIT_BRANCH: ${{ inputs.branch_name || github.ref_name }}
    steps:
          
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha || github.ref }}

      - name: Set Pending Status
        if: inputs.sha != ''
        uses: guibranco/github-status-action-v2@v1.1.13
        with:
          authToken: ${{ github.token }}
          context: "chatops-quality-gate"  # –ó–º—ñ–Ω–µ–Ω–æ –Ω–∞ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç
          state: "pending"
          sha: ${{ inputs.sha }}
          description: "Analysis is running..."
          # –î–æ–¥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è, —â–æ–± target_url –Ω–µ –±—É–≤ –ø–æ—Ä–æ–∂–Ω—ñ–º
          target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Upload SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
          checkout_path: ${{ github.workspace }}

      - name: Mock Lint and Test
        run: |
          echo "Testing branch: $CI_COMMIT_BRANCH"
          echo "Running on SHA: ${{ inputs.sha || github.sha }}"
          sleep 5
          echo "Linting complete. Tests passed!"

      - name: Set Final Status
        if: always() && inputs.sha != ''
        uses: guibranco/github-status-action-v2@v1.1.13
        with:
          authToken: ${{ github.token }}
          context: "chatops-quality-gate"  # –ú–∞—î –±—É—Ç–∏ —Ç–∞–∫–∏–º —Å–∞–º–∏–º
          state: ${{ job.status }}
          sha: ${{ inputs.sha }}
          description: "Analysis finished with status: ${{ job.status }}"
          target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"